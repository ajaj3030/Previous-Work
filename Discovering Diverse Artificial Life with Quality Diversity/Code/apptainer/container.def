Bootstrap: docker
From: ubuntu:22.04

%help
	Leniabreeder: Toward Artificial Open-Ended Evolution within Lenia using Quality-Diversity

%environment
	# System
	export TZ=Europe/London
	export OPENBLAS_NUM_THREADS=1

	# Activate virtual environment permanently
	export VIRTUAL_ENV="/venv"
	export _OLD_VIRTUAL_PATH="$PATH"
	export PATH="$VIRTUAL_ENV/bin:$PATH"

	# Add /workspace/src/ to PYTHONPATH
	export PYTHONPATH="/workspace/src"

%post
	echo "export WANDB_API_KEY=$WANDB_API_KEY" >> $APPTAINER_ENVIRONMENT
	export DEBIAN_FRONTEND=noninteractive

	# Update and install required libraries
	apt update
	apt install -y wget git software-properties-common ffmpeg

	# Install Python
	add-apt-repository ppa:deadsnakes/ppa
	apt install -y python3.11 python3.11-venv

	# Create a virtual environment
	python3.11 -m venv /venv
	. /venv/bin/activate
	python -m ensurepip
	pip install --upgrade pip

	# Set up workspace
	mkdir /workspace/ && cd /workspace/

	# Clone repository to /src/
	git clone https://gitlab.doc.ic.ac.uk/AIRL/students_projects/2023-2024/aidan_holmes/lenia.git src/ && cd src/
	git checkout d7be28f329d6985db1b212f802376c3132c0a1af

	# Install requirements
	 # Install requirements (excluding jax and jaxlib)
    pip install --upgrade pip
    grep -v "jax" requirements.txt | grep -v "jaxlib" | pip install -r /dev/stdin

    # Install CUDA-enabled JAX
    # pip install --upgrade "jax[cuda12_local]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

    # If you need a specific version, you can use:
    pip install jax==0.4.28 jaxlib==0.4.28+cuda12.cudnn89 -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

%runscript
	# Run main
	python /workspace/src/main.py "$@"
